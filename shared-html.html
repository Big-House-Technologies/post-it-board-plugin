<script>
    window.renderExistingPostIts = function(canvasID, existingPostItObjects, properties, instance) {
      const board = document.getElementById(canvasID);
      if (!board) {
        console.warn("⚠️ Canvas not found.");
        return;
      }
  
      const postItStyle = {
        position: "absolute",
        width: "100px",
        height: "100px",
        background: "yellow",
        border: "1px solid black",
        padding: "10px",
        cursor: "grab",
        userSelect: "none"
      };
  
      function createPostIt(x, y, text, postItId) {
        const postIt = document.createElement("div");
        postIt.classList.add("post-it");
        Object.assign(postIt.style, postItStyle);
        postIt.contentEditable = "true";
        postIt.innerText = text;
        postIt.setAttribute("data-postit-id", postItId);
        postIt.style.left = x + "px";
        postIt.style.top = y + "px";
        return postIt;
      }
  
      existingPostItObjects.forEach(postItObject => {
        const x = postItObject[properties.xField] || 0;
        const y = postItObject[properties.yField] || 0;
        const postItId = postItObject[properties.postItObject]?.id || "pi_" + Math.random().toString(36).substr(2, 14);
        const text = postItObject[properties.textField] || "Existing Post-It";
  
        const postIt = createPostIt(x, y, text, postItId);
        board.appendChild(postIt);
  
        postIt.addEventListener("click", function () {
          instance.publishState("postItX", x);
          instance.publishState("postItY", y);
          instance.publishState("postItText", postIt.innerText);
          instance.publishState("postItId", postIt.getAttribute("data-postit-id"));
          instance.triggerEvent("postItClicked");
        });
  
        enableDrag(postIt, instance, board);
      });
  
      function enableDrag(postIt, instance, board) {
        let offsetX, offsetY, isDragging = false;
  
        postIt.addEventListener("mousedown", function (e) {
          isDragging = true;
          offsetX = e.clientX - postIt.offsetLeft;
          offsetY = e.clientY - postIt.offsetTop;
          postIt.style.cursor = "grabbing";
        });
  
        document.addEventListener("mousemove", function (e) {
          if (isDragging) {
            const boardRect = board.getBoundingClientRect();
            const postItWidth = postIt.clientWidth;
            const postItHeight = postIt.clientHeight;
            const newX = e.clientX - offsetX;
            const newY = e.clientY - offsetY;
  
            const constrainedX = Math.max(0, Math.min(newX, boardRect.width - postItWidth));
            const constrainedY = Math.max(0, Math.min(newY, boardRect.height - postItHeight));
  
            postIt.style.left = constrainedX + "px";
            postIt.style.top = constrainedY + "px";
  
            instance.publishState("postItX", constrainedX);
            instance.publishState("postItY", constrainedY);
            instance.publishState("postItText", postIt.innerText);
            instance.publishState("postItId", postIt.getAttribute("data-postit-id"));
          }
        });
  
        document.addEventListener("mouseup", function () {
          if (isDragging) {
            isDragging = false;
            postIt.style.cursor = "grab";
            instance.triggerEvent("postItUpdated");
          }
        });
  
        postIt.addEventListener("input", function () {
          instance.publishState("postItText", postIt.innerText);
          instance.publishState("postItId", postIt.getAttribute("data-postit-id"));
          instance.triggerEvent("postItUpdated");
        });
      }
    };
  </script>
  